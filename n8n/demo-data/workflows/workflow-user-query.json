{
  "name": "User Query - Shopping Agent",
  "description": "ì‚¬ìš©ìì˜ ì¿¼ë¦¬ë¥¼ ë°›ì•„ ë©€í‹° ì—ì´ì „íŠ¸ë¡œ ë¶„ì„ ë° ë‹µë³€ ìƒì„±",
  "nodes": [
    {
      "id": "1",
      "type": "n8n-nodes-base.webhook",
      "position": [250, 300],
      "parameters": {
        "path": "ask",
        "httpMethod": "POST",
        "responseMode": "lastNode",
        "expectedBodyJSON": {
          "query": "ê±´ì¡°í•œ í”¼ë¶€ì— ì¢‹ì€ í† ë„ˆ ì¶”ì²œí•´ì¤˜",
          "user_id": "user123"
        }
      },
      "name": "Webhook"
    },
    {
      "id": "2",
      "type": "n8n-nodes-base.openai",
      "position": [450, 300],
      "parameters": {
        "resource": "chat",
        "model": "gpt-4o-mini",
        "messages": {
          "messageUiValues": [
            {
              "role": "system",
              "content": "ë‹¹ì‹ ì€ ì¿¼ë¦¬ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\nì‚¬ìš©ìì˜ ì§ˆë¬¸ì„ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì„¸ìš”:\n\n1. intent: ì˜ë„ (ì¶”ì²œ, ë¹„êµ, ë¦¬ë·° ìš”ì•½ ë“±)\n2. keywords: í•µì‹¬ í‚¤ì›Œë“œ ë°°ì—´ (ìµœëŒ€ 3ê°œ)\n3. filters: í•„í„° ì¡°ê±´ (í”¼ë¶€ íƒ€ì…, ê°€ê²©ëŒ€ ë“±)\n\nJSON í˜•ì‹ìœ¼ë¡œ ì¶œë ¥:\n{\"intent\": \"ì¶”ì²œ\", \"keywords\": [\"í‚¤ì›Œë“œ1\", \"í‚¤ì›Œë“œ2\"], \"filters\": {\"skin_type\": \"ê±´ì„±\"}}"
            },
            {
              "role": "user",
              "content": "{{$json.query}}"
            }
          ]
        },
        "temperature": 0.3,
        "responseFormat": "json"
      },
      "name": "Parse User Intent"
    },
    {
      "id": "3",
      "type": "n8n-nodes-base.postgres",
      "position": [650, 300],
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT r.*, p.name, p.price FROM reviews r JOIN products p ON r.product_number = p.product_number WHERE r.sentiment_score >= 4 ORDER BY r.like_count DESC, r.registered_at DESC LIMIT 20;"
      },
      "name": "Keyword Search"
    },
    {
      "id": "4",
      "type": "n8n-nodes-base.code",
      "position": [850, 300],
      "parameters": {
        "language": "javascript",
        "jsCode": "// OpenAI embedding ê²°ê³¼ë¥¼ ë°›ì•„ì„œ ì›ë³¸ ì¿¼ë¦¬ì™€ í•¨ê»˜ ì „ë‹¬\nconst embedding = items[0].json.data[0].embedding;\n\nreturn [{\n  json: {\n    ...items[0].json,\n    data: embedding,\n    originalQuery: items[0].json.query || ''\n  }\n}];"
      },
      "name": "Generate Query Embedding"
    },
    {
      "id": "5",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1050, 300],
      "parameters": {
        "method": "POST",
        "url": "http://qdrant:6333/collections/beauty_reviews/points/search",
        "body": "{\n  \"vector\": {{$json.data}},\n  \"limit\": 20,\n  \"with_payload\": true,\n  \"score_threshold\": 0.7\n}",
        "contentType": "application/json"
      },
      "name": "Vector Search"
    },
    {
      "id": "6",
      "type": "n8n-nodes-base.code",
      "position": [1250, 300],
      "parameters": {
        "language": "javascript",
        "mode": "runOnceForAllItems",
        "jsCode": "// Node 3: Keyword Search results\nconst keywordResults = items[0].json || [];\n\n// Node 5: Vector Search results\nconst vectorResults = items[1].json.result || [];\n\nconst merged = {};\n\n// ë²¡í„° ê²€ìƒ‰ ê²°ê³¼ (ê°€ì¤‘ì¹˜ 0.7)\nvectorResults.forEach(item => {\n  const id = `vec_${item.id}`;\n  merged[id] = {\n    ...item.payload,\n    source: 'vector',\n    score: item.score * 0.7\n  };\n});\n\n// í‚¤ì›Œë“œ ê²€ìƒ‰ ê²°ê³¼ (ê°€ì¤‘ì¹˜ 0.3)\nkeywordResults.forEach((item, idx) => {\n  const id = `kw_${item.id || idx}`;\n  const keywordScore = Math.max(0, (20 - idx) / 20) * 0.3;\n  \n  if (merged[id]) {\n    merged[id].score += keywordScore;\n  } else {\n    merged[id] = {\n      ...item,\n      source: 'keyword',\n      score: keywordScore\n    };\n  }\n});\n\n// ì ìˆ˜ ìˆœ ì •ë ¬ í›„ Top 10\nconst sorted = Object.values(merged)\n  .sort((a, b) => b.score - a.score)\n  .slice(0, 10);\n\n// ë¦¬ë·° ëª©ë¡ ë³‘í•©\nconst reviews = sorted.map(item => `[${item.source}] ${item.content} (ì ìˆ˜: ${item.sentiment_score}/5)`).join('\\\\n');\n\nreturn [{\n  json: {\n    reviews: reviews,\n    review_count: sorted.length,\n    avg_score: sorted.reduce((sum, item) => sum + (item.sentiment_score || 0), 0) / sorted.length,\n    top_results: sorted\n  }\n}];"
      },
      "name": "Merge Results"
    },
    {
      "id": "7",
      "type": "n8n-nodes-base.openai",
      "position": [1450, 300],
      "parameters": {
        "resource": "chat",
        "model": "gpt-4o-mini",
        "messages": {
          "messageUiValues": [
            {
              "role": "system",
              "content": "ë‹¤ìŒ ë¦¬ë·°ë“¤ì„ ê¸°ë°˜ìœ¼ë¡œ ì œí’ˆ ì†ì„±ë³„ ê°ì •ì„ ë¶„ì„í•˜ì„¸ìš”.\n\nì£¼ìš” ì†ì„±: ë³´ìŠµë ¥, í¡ìˆ˜ë ¥, ëˆì ì„, í–¥, í”¼ë¶€ ìê·¹, ê°€ì„±ë¹„\n\nê° ì†ì„±ì— ëŒ€í•´:\n1. ì ìˆ˜ (1-5)\n2. ê¸ì • ë¦¬ë·° ê°œìˆ˜\n3. ë¶€ì • ë¦¬ë·° ê°œìˆ˜\n4. ëŒ€í‘œ ë¦¬ë·° ì¸ìš©\n\në°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œ ì¶œë ¥:\n{\"attributes\": [{\"name\": \"ì†ì„±ëª…\", \"score\": 4, \"positive\": 5, \"negative\": 1, \"example\": \"ë¦¬ë·° í…ìŠ¤íŠ¸\"}]}"
            },
            {
              "role": "user",
              "content": "ë¦¬ë·° ëª©ë¡:\\n{{$json.reviews}}\n\ní‰ê·  ì ìˆ˜: {{$json.avg_score}}"
            }
          ]
        },
        "temperature": 0.3,
        "responseFormat": "json"
      },
      "name": "ABSA Analysis"
    },
    {
      "id": "8",
      "type": "n8n-nodes-base.openai",
      "position": [1650, 300],
      "parameters": {
        "resource": "chat",
        "model": "gpt-4o",
        "messages": {
          "messageUiValues": [
            {
              "role": "system",
              "content": "ë‹¹ì‹ ì€ 10ë…„ ê²½ë ¥ì˜ ì „ì§ ë·°í‹° MDì…ë‹ˆë‹¤.\nì†”ì§í•˜ê³  ê·¼ê±° ìˆëŠ” ì¡°ì–¸ì„ ì œê³µí•˜ì„¸ìš”.\n\në‹µë³€ êµ¬ì¡°:\n1. ğŸ¯ 3ì¤„ ìš”ì•½\n2. ğŸ“Š ì¥ë‹¨ì  (ê¸ì •/ë¶€ì • ë¦¬ë·° ê°œìˆ˜ í¬í•¨)\n3. âš ï¸ ê´‘ê³  vs ì‹¤ì œ ì°¨ì´\n4. âœ…/âŒ ìµœì¢… íŒë‹¨ (ì¶”ì²œ/ë¹„ì¶”ì²œ)\n\nê·¼ê±°ëŠ” ë°˜ë“œì‹œ í†µê³„ì™€ ë¦¬ë·° ì¸ìš©ìœ¼ë¡œ ë’·ë°›ì¹¨í•˜ì„¸ìš”."
            },
            {
              "role": "user",
              "content": "ì‚¬ìš©ì ì§ˆë¬¸: {{$json.originalQuery}}\n\nìˆ˜ì§‘ëœ ë¦¬ë·° ìˆ˜: {{$json.review_count}}ê°œ\ní‰ê·  í‰ì : {{$json.avg_score}}/5\n\nABSA ë¶„ì„:\\n{{$json.message.content}}"
            }
          ]
        },
        "temperature": 0.7
      },
      "name": "Generate Answer"
    },
    {
      "id": "9",
      "type": "n8n-nodes-base.respondToWebhook",
      "position": [1850, 300],
      "parameters": {
        "responseData": "firstEntryJson",
        "responseBody": "{\"success\": true, \"answer\": \"{{$json.message.content}}\", \"metadata\": {\"reviews_analyzed\": \"{{$json.review_count}}\", \"avg_score\": \"{{$json.avg_score}}\", \"generated_at\": \"{{$now}}\"}}"
      },
      "name": "Respond to Webhook"
    }
  ],
  "connections": {
    "1": {
      "main": [[{"node": "2", "type": "main", "index": 0}]]
    },
    "2": {
      "main": [[{"node": "3", "type": "main", "index": 0}], [{"node": "4", "type": "main", "index": 0}]]
    },
    "3": {
      "main": [[{"node": "6", "type": "main", "index": 0}]]
    },
    "4": {
      "main": [[{"node": "5", "type": "main", "index": 0}]]
    },
    "5": {
      "main": [[{"node": "6", "type": "main", "index": 0}]]
    },
    "6": {
      "main": [[{"node": "7", "type": "main", "index": 0}]]
    },
    "7": {
      "main": [[{"node": "8", "type": "main", "index": 0}]]
    },
    "8": {
      "main": [[{"node": "9", "type": "main", "index": 0}]]
    }
  },
  "active": false
}
